<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Umidade por Profundidade - RC Engenharia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; }
        .header { background: #fff; padding: 1em 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-title { display: flex; align-items: center; gap: 1em; }
        .logo-header { height: 40px; }
        .header h1 { color: #0056b3; margin: 0; font-size: 1.5em; }
        .btn-voltar { font-size: 0.9em; font-weight: bold; color: #007bff; text-decoration: none; background-color: transparent; border: 2px solid #007bff; padding: 0.5em 1em; border-radius: 20px; transition: all 0.3s ease; }
        .btn-voltar:hover { background-color: #007bff; color: white; }
        .main-container { display: flex; flex-direction: column; padding: 1.5em; gap: 1.5em; }
        .card { background: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 0.5em; margin-top: 0; font-size: 1.2em; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 0.7em; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        th { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo da Empresa" class="logo-header">
            <h1>Dashboard RC Engenharia</h1>
        </div>
        <div><a href="/mapa" class="btn-voltar">⬅️ Voltar ao Mapa</a></div>
    </div>
    <div class="main-container">
        <div class="card">
            <h2>Umidade do Solo por Profundidade (VWC m³/m³)</h2>
            <canvas id="umidadeChart"></canvas>
        </div>
        <div class="card">
            <h2>Últimas Leituras</h2>
            <table id="real-time-table">
                <thead><tr><th>Horário</th><th>Prof. 0,3 m</th><th>Prof. 0,8 m</th><th>Prof. 1,5 m</th><th>Prof. 2,0 m</th><th>Prof. 2,5 m</th></tr></thead>
                <tbody id="tabela-dados"></tbody>
            </table>
        </div>
    </div>

    <script>
        let umidadeChart, updateInterval;
        const MAX_LINHAS_TABELA = 15;
        const MAX_PONTOS_GRAFICO = 30;
        const cores = ['#007bff', '#198754', '#ffc107', '#fd7e14', '#dc3545'];
        const legendas = ['Prof. 0,3 m', 'Prof. 0,8 m', 'Prof. 1,5 m', 'Prof. 2,0 m', 'Prof. 2,5 m'];

        function renderizarDashboard(dados) {
            if (umidadeChart) umidadeChart.destroy();
            
            const labels = dados.map(d => new Date(d.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
            
            const datasets = [];
            for (let i = 1; i <= 5; i++) {
                datasets.push({
                    label: legendas[i-1],
                    data: dados.map(d => d[`umidade_p${i}`]),
                    borderColor: cores[i-1],
                    tension: 0.1,
                    fill: false
                });
            }

            const ctx = document.getElementById('umidadeChart').getContext('2d');
            umidadeChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: datasets } });

            const tbody = document.getElementById('tabela-dados');
            tbody.innerHTML = '';
            dados.slice(-MAX_LINHAS_TABELA).reverse().forEach(leitura => {
                const newRow = tbody.insertRow(0);
                newRow.innerHTML = `
                    <td>${new Date(leitura.timestamp).toLocaleString('pt-BR')}</td>
                    <td>${leitura.umidade_p1.toFixed(3)}</td>
                    <td>${leitura.umidade_p2.toFixed(3)}</td>
                    <td>${leitura.umidade_p3.toFixed(3)}</td>
                    <td>${leitura.umidade_p4.toFixed(3)}</td>
                    <td>${leitura.umidade_p5.toFixed(3)}</td>
                `;
            });
        }
        
        async function buscarAtualizacao() {
             try {
                const response = await fetch('/api/dados_atuais');
                if (!response.ok) return;
                const novaLeitura = await response.json();
                
                const tbody = document.getElementById('tabela-dados');
                const newRow = tbody.insertRow(0);
                newRow.innerHTML = `
                    <td>${new Date(novaLeitura.timestamp).toLocaleString('pt-BR')}</td>
                    <td>${novaLeitura.umidade_p1.toFixed(3)}</td>
                    <td>${novaLeitura.umidade_p2.toFixed(3)}</td>
                    <td>${novaLeitura.umidade_p3.toFixed(3)}</td>
                    <td>${novaLeitura.umidade_p4.toFixed(3)}</td>
                    <td>${novaLeitura.umidade_p5.toFixed(3)}</td>
                `;
                while (tbody.rows.length > MAX_LINHAS_TABELA) { tbody.deleteRow(tbody.rows.length - 1); }

                umidadeChart.data.labels.push(new Date(novaLeitura.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
                if (umidadeChart.data.labels.length > MAX_PONTOS_GRAFICO) umidadeChart.data.labels.shift();

                for (let i = 0; i < 5; i++) {
                    umidadeChart.data.datasets[i].data.push(novaLeitura[`umidade_p${i+1}`]);
                    if (umidadeChart.data.datasets[i].data.length > MAX_PONTOS_GRAFICO) {
                        umidadeChart.data.datasets[i].data.shift();
                    }
                }
                umidadeChart.update({duration: 0});
            } catch (error) { console.error("Erro na atualização em tempo real:", error); }
        }
        
        async function carregarDadosIniciais() { 
            try { 
                const response = await fetch(`/api/dados`);
                const dados = await response.json();
                if (dados && dados.length > 0) {
                    renderizarDashboard(dados);
                    updateInterval = setInterval(buscarAtualizacao, 2000);
                }
            } catch (error) { console.error("Erro ao carregar dados:", error); } 
        }
        
        document.addEventListener('DOMContentLoaded', carregarDadosIniciais);
    </script>
</body>
</html>

