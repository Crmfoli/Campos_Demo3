<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Sensor</title>
    <!-- Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-header { border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Cabeçalho -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard de Monitoramento</h1>
            <p class="text-gray-500">Dispositivo: <span id="device-id" class="font-semibold">{{ device_id }}</span></p>
            <p class="text-sm text-gray-400">Última leitura: <span id="timestamp">--:--:--</span></p>
        </header>

        <!-- Painel de Leituras Atuais -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <!-- Card de Umidade (Exemplo) -->
            <div id="card-p1" class="card p-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-sm font-semibold text-gray-500">Prof. 0,3 m</h3>
                <p id="umidade_p1" class="text-4xl font-bold text-blue-600">--.-</p>
                <span class="text-gray-500">% umidade</span>
            </div>
            <div id="card-p2" class="card p-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-sm font-semibold text-gray-500">Prof. 0,8 m</h3>
                <p id="umidade_p2" class="text-4xl font-bold text-blue-600">--.-</p>
                <span class="text-gray-500">% umidade</span>
            </div>
            <div id="card-p3" class="card p-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-sm font-semibold text-gray-500">Prof. 1,5 m</h3>
                <p id="umidade_p3" class="text-4xl font-bold text-blue-600">--.-</p>
                <span class="text-gray-500">% umidade</span>
            </div>
            <div id="card-p4" class="card p-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-sm font-semibold text-gray-500">Prof. 2,0 m</h3>
                <p id="umidade_p4" class="text-4xl font-bold text-blue-600">--.-</p>
                <span class="text-gray-500">% umidade</span>
            </div>
            <div id="card-p5" class="card p-4 flex flex-col items-center justify-center text-center">
                <h3 class="text-sm font-semibold text-gray-500">Prof. 2,5 m</h3>
                <p id="umidade_p5" class="text-4xl font-bold text-blue-600">--.-</p>
                <span class="text-gray-500">% umidade</span>
            </div>
        </div>

        <!-- Gráfico -->
        <div class="card p-4 md:p-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Histórico de Umidade</h2>
            <canvas id="umidadeChart"></canvas>
        </div>
    </div>

    <script>
        const MAX_DATA_POINTS = 50; // Quantos pontos mostrar no gráfico
        let umidadeChart;

        // Função para atualizar os cards com os novos dados
        function atualizarCards(dados) {
            document.getElementById('timestamp').textContent = new Date(dados.timestamp).toLocaleTimeString('pt-BR');
            document.getElementById('umidade_p1').textContent = dados.umidade_p1.toFixed(1);
            document.getElementById('umidade_p2').textContent = dados.umidade_p2.toFixed(1);
            document.getElementById('umidade_p3').textContent = dados.umidade_p3.toFixed(1);
            document.getElementById('umidade_p4').textContent = dados.umidade_p4.toFixed(1);
            document.getElementById('umidade_p5').textContent = dados.umidade_p5.toFixed(1);
        }

        // Função para atualizar o gráfico
        function atualizarGrafico(dados) {
            const chart = umidadeChart;
            const timestamp = new Date(dados.timestamp);

            // Adiciona o novo timestamp ao eixo X
            chart.data.labels.push(timestamp);

            // Adiciona os novos dados de umidade a cada linha do gráfico
            chart.data.datasets[0].data.push(dados.umidade_p1);
            chart.data.datasets[1].data.push(dados.umidade_p2);
            chart.data.datasets[2].data.push(dados.umidade_p3);
            chart.data.datasets[3].data.push(dados.umidade_p4);
            chart.data.datasets[4].data.push(dados.umidade_p5);

            // Remove os dados mais antigos para manter o gráfico limpo
            if (chart.data.labels.length > MAX_DATA_POINTS) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }

            // Atualiza o gráfico na tela
            chart.update();
        }

        // Função principal que busca os dados da API
        async function buscarDadosAtuais() {
            try {
                const response = await fetch('/api/dados_atuais');
                if (!response.ok) {
                    console.error("Erro ao buscar dados da API:", response.statusText);
                    return;
                }
                const dados = await response.json();
                
                if (dados.error) {
                    console.error("API retornou um erro:", dados.error);
                    return;
                }

                atualizarCards(dados);
                atualizarGrafico(dados);

            } catch (error) {
                console.error("Falha na comunicação com a API.", error);
            }
        }
        
        // Inicializa o gráfico quando a página carrega
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('umidadeChart').getContext('2d');
            umidadeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Eixo X (tempo)
                    datasets: [
                        { label: 'Prof. 0,3 m', data: [], borderColor: 'rgb(59, 130, 246)', tension: 0.1, fill: false },
                        { label: 'Prof. 0,8 m', data: [], borderColor: 'rgb(34, 197, 94)', tension: 0.1, fill: false },
                        { label: 'Prof. 1,5 m', data: [], borderColor: 'rgb(234, 179, 8)', tension: 0.1, fill: false },
                        { label: 'Prof. 2,0 m', data: [], borderColor: 'rgb(249, 115, 22)', tension: 0.1, fill: false },
                        { label: 'Prof. 2,5 m', data: [], borderColor: 'rgb(239, 68, 68)', tension: 0.1, fill: false },
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm:ss'
                                }
                            },
                            title: { display: true, text: 'Horário' }
                        },
                        y: {
                            title: { display: true, text: 'Umidade (%)' },
                            beginAtZero: false
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });

            // Inicia a busca de dados a cada 2 segundos
            setInterval(buscarDadosAtuais, 2000);
        });
    </script>
</body>
</html>
